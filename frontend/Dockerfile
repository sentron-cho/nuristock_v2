# # # í”„ë¡œì íŠ¸ ë¹Œë“œ
# # FROM node:20 AS builder
# # WORKDIR /app
# # COPY . .
# # COPY package*.json .
# # # RUN npm ci

# # RUN rm -rf node_modules package-lock.json \
# #   && npm install \
# #   && npm run build

# # # Production ëŸ°íƒ€ì„ - nginx
# # FROM nginxinc/nginx-unprivileged:1.23 AS runner
# # WORKDIR /usr/share/nginx/html
# # COPY --from=builder /app/dist .

# # EXPOSE 3000
# # CMD ["nginx", "-g", "daemon off;"]

# # 1ï¸âƒ£ Node.js í™˜ê²½ì—ì„œ React ë¹Œë“œ
# FROM node:20 AS build
# WORKDIR /app

# # package.jsonê³¼ package-lock.jsonì„ ë¨¼ì € ë³µì‚¬í•˜ì—¬ ì˜ì¡´ì„± ì„¤ì¹˜
# COPY package.json package-lock.json ./
# RUN rm -rf node_modules package-lock.json \
#   && npm install

# # ì „ì²´ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ í›„ ë¹Œë“œ ì‹¤í–‰
# COPY . .
# RUN npm run build

# RUN rm -rf /user/share/nginx/html/*

# RUN mkdir -p /var/cache/nginx/client_temp

# COPY nginx.conf /etc/nginx/conf.d/default.conf

# # 2ï¸âƒ£ Nginxë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì  íŒŒì¼ ì„œë¹™
# FROM nginx:alpine
# COPY --from=build /app/dist/ /usr/share/nginx/html

# # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# # ENV PORT=80
# EXPOSE 3000

# CMD ["nginx", "-g", "daemon off;"]


# 1ï¸âƒ£ ë¹Œë“œ ìŠ¤í…Œì´ì§€
FROM node:20 AS build

WORKDIR /app

COPY package.json package-lock.json ./
RUN rm -rf node_modules package-lock.json \
  && npm install

COPY . .
RUN npm run build


# 2ï¸âƒ£ nginx ìŠ¤í…Œì´ì§€
FROM nginx:alpine

# ğŸ’¡ default.conf ì œê±° (ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ì˜¤ë¥˜ ë°©ì§€)
RUN rm /etc/nginx/conf.d/default.conf

# ğŸ”§ nginx ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„± + ê¶Œí•œ ë¶€ì—¬ (ì¤‘ìš”!)
RUN mkdir -p /var/cache/nginx/client_temp && \
    chown -R nginx:nginx /var/cache/nginx

# ğŸ”„ nginx ì„¤ì • ë³µì‚¬ (default.conf ë˜ëŠ” nginx.conf)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# ğŸ“ ì •ì  íŒŒì¼ ë³µì‚¬
COPY --from=build /app/dist /usr/share/nginx/html

# Set enviroment variable from nginx config
RUN chown nginx:nginx /etc/nginx/
RUN chown nginx:nginx /etc/nginx/*
RUN chown nginx:nginx /etc/nginx/config.d/*.conf
RUN chown nginx:nginx /user/lib/nginx/modules/
RUN chown nginx:nginx /user/lib/nginx/modules/*
RUN chown nginx:nginx /var/log/nginx/
RUN chown nginx:nginx /user/share/nginx/

RUN chown 750 /etc/nginx/
RUN chown 750 /etc/nginx/*
RUN chown 750 /etc/nginx/config.d/*.conf
RUN chown 750 /user/lib/nginx/modules/
RUN chown 750 /user/lib/nginx/modules/*
RUN chown 750 /var/log/nginx/
RUN chown 750 /var/log/nginx/*
RUN chown 750 /user/share/nginx/

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]